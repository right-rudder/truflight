---
import Header from "../components/Header.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
const ENROLLMENT_FORM_WEBHOOK_URL = import.meta.env.ENROLLMENT_FORM_WEBHOOK_URL;
const PORTAL_API_KEY = import.meta.env.PORTAL_API_KEY;

const headerData = {
  title: "Enrollment Form",
  primaryImage: "/src/assets/trees-foreground-helicopter-background-truflight-dallas-fort-worth-flight-school.jpg",
  primaryAlt: "Discovery Flight Helicopter at TruFlight Academy",
};
---

<BaseLayout
  siteTitle="Enroll in Helicopter Flight Training | TruFlight Academy Dallas, TX"
  siteDescription="Ready to start your aviation journey? Enroll in helicopter flight training at TruFlight Academy in Dallas, TX. Choose from private, commercial, instrument, and external load programs. Train with expert instructors and modern Cabri G2 helicoptersâ€”apply today!"
>
  <Header slot="hero" data={headerData} />

  <section class="mx-auto max-w-xl px-4 py-20 lg:max-w-6xl lg:px-12">
    <strong
      class="text-primary-500 mx-auto block w-fit text-center text-lg font-bold"
      >Enrollment Form</strong
    >
    <h2 class="font-display mt-3 mb-5 text-center text-5xl font-bold">
      Ready to Take Off? Enroll Today!
    </h2>
    <form id="enrollment_form">
      <div class="grid grid-cols-1 gap-x-8 gap-y-2 sm:grid-cols-2">
        <div>
          <div class="mt-2.5">
            <input
              type="text"
              name="first-name"
              id="first-name"
              autocomplete="given-name"
              placeholder="First Name"
              required
              class="border-primary-400 focus:border-primary-500 outline-primary-500 w-full rounded border bg-white p-3 placeholder:text-sm placeholder:font-semibold"
            />
          </div>
        </div>
        <div>
          <div class="mt-2.5">
            <input
              type="text"
              name="last-name"
              id="last-name"
              autocomplete="family-name"
              placeholder="Last Name"
              required
              class="border-primary-400 focus:border-primary-500 outline-primary-500 w-full rounded border bg-white p-3 placeholder:text-sm placeholder:font-semibold"
            />
          </div>
        </div>
        <div>
          <div class="mt-2.5">
            <input
              type="email"
              name="email"
              id="email"
              autocomplete="email"
              placeholder="Email"
              required
              class="border-primary-400 focus:border-primary-500 outline-primary-500 w-full rounded border bg-white p-3 placeholder:text-sm placeholder:font-semibold"
            />
          </div>
        </div>
        <p class="hidden">
          <label>
            Don't fill this out if you're human: <input name="confirm-email" />
          </label>
        </p>
        <div>
          <div class="relative mt-2.5">
            <input
              type="tel"
              name="phone"
              id="phone"
              autocomplete="tel"
              placeholder="Phone"
              required
              class="border-primary-400 focus:border-primary-500 outline-primary-500 w-full rounded border bg-white p-3 placeholder:text-sm placeholder:font-semibold"
            />
          </div>
        </div>
        <div class="sm:col-span-2">
          <div class="mt-2.5">
            <select
              name="program-interest"
              id="program-interest"
              required
              class="border-primary-400 focus:border-primary-500 outline-primary-500 w-full rounded border bg-white p-3 text-sm placeholder:text-sm placeholder:font-semibold"
            >
              <option value="" disabled selected>
                Select Program of Interest
              </option>
              <option value="Private Pilot">Private Pilot</option>
              <option value="Instrument Pilot">Instrument Pilot </option>
              <option value="Commercial Pilot">Commercial Pilot</option>
              <option value="External Load Training"
                >External Load Training</option
              >
              <option value="Private Helicopter Add-On"
                >Private Helicopter Add-On</option
              >
              <option value="Instrument Helicopter Add-On"
                >Instrument Helicopter Add-On</option
              >
              <option value="Commercial Helicopter Add-On"
                >Commercial Helicopter Add-On</option
              >
              <option value="10hr Block Package">10hr Block Package</option>
              <option value="20hr Block Package">20hr Block Package</option>
              <option value="Voyager Package">Voyager Package</option>
              <option value="Ground School">Ground School</option>
              <option value="Solo/Rentals">Solo/Rentals</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="sm:col-span-2">
          <div class="mt-2.5">
            <select
              name="weight-is-240lbs-or-less"
              id="weight-is-240lbs-or-less"
              required
              class="border-primary-400 focus:border-primary-500 outline-primary-500 w-full rounded border bg-white p-3 text-sm placeholder:text-sm placeholder:font-semibold"
            >
              <option value="" disabled selected>
                Is your weight 240 lbs or less?
              </option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
        <div class="sm:col-span-2">
          <div class="mt-2.5">
            <textarea
              name="experience-goals"
              id="experience-goals"
              rows="4"
              placeholder="Tell us more about your flying experience and goals..."
              class="border-primary-400 focus:border-primary-500 outline-primary-500 w-full rounded border bg-white p-3 placeholder:text-sm placeholder:font-semibold"
            ></textarea>
          </div>
        </div>
        <div class="mt-5 flex gap-x-4 sm:col-span-2">
          <div class="flex items-center gap-2">
            <input
              type="checkbox"
              id="agree-terms"
              name="agree-terms"
              class="h-4 w-4 cursor-pointer rounded border-gray-300 bg-white text-gray-900 focus:ring-2 focus:ring-gray-900"
              required
            />
            <label
              for="agree-terms"
              class="text-accent-400 ml-2 text-sm font-medium tracking-wider lg:text-base/6"
            >
              I agree to <a
                href="/privacy-policy-and-terms-of-service"
                target="_blank"
                class="underline">terms & conditions</a
              > provided by the company. By providing my phone number, I agree to
              receive text messages from TruFlight Academy.
            </label>
          </div>
        </div>
        <div class="mt-5">
          <button
            id="submit-button"
            type="submit"
            class="btn-primary cursor-pointer">Submit</button
          >
        </div>
      </div>
    </form>
  </section>

  <script define:vars={{ ENROLLMENT_FORM_WEBHOOK_URL, PORTAL_API_KEY }}>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("enrollment_form");
      if (!form) {
        console.error("Form element not found.");
        return;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(form);
        const confirmEmail = formData.get("confirm-email")?.trim();
        if (confirmEmail) return;

        const webhookURL = ENROLLMENT_FORM_WEBHOOK_URL;
        const apiKey = PORTAL_API_KEY;

        const urlEncodedBody = new URLSearchParams(formData).toString();

        const excludedFields = [
          "first-name",
          "last-name",
          "email",
          "phone",
          "confirm-email",
          "agree-data-collection",
        ];

        const metadata = {};

        for (const [key, value] of formData.entries()) {
          if (!excludedFields.includes(key)) {
            metadata[key] = value?.trim?.() ?? value;
          }
        }

        const jsonBody = {
          first_name: formData.get("first-name")?.trim() || "",
          last_name: formData.get("last-name")?.trim() || "",
          email: formData.get("email")?.trim() || "",
          phone: formData.get("phone")?.trim() || "",
          campaign: "enrollment",
          account_random_id: "ac_jvesu2r5",
          metadata: metadata,
        };

        try {
          const [ghlRes, portalRes] = await Promise.all([
            fetch(webhookURL, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: urlEncodedBody,
            }),
            fetch("https://portal.rightruddermarketing.com/api/leads", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                "x-api-key": apiKey,
              },
              body: JSON.stringify(jsonBody),
            }),
          ]);

          if (ghlRes.ok && portalRes.ok) {
            window.location.href = "/enrollment-confirmation";
          } else {
            console.error("Submission failed", {
              ghlStatus: ghlRes.status,
              portalStatus: portalRes.status,
            });
          }
        } catch (err) {
          console.error("Submission error:", err);
        }
      });
    });
  </script>
</BaseLayout>
